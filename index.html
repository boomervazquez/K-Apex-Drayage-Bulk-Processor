<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Bulk Rate Processor . Reset Build</title>
<style>
  :root{--bg:#f4f4f4;--card:#ffffff;--text:#1f2937;--muted:#6b7280;--gray:#575757;--orange:#f36f21;--ok:#10b981;--err:#ef4444}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text)}
  .wrap{max-width:980px;margin:24px auto;padding:0 16px}
  .card{background:var(--card);border-radius:14px;box-shadow:0 2px 10px rgba(0,0,0,.06);padding:16px;margin-bottom:16px}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  h1{font-size:20px;margin:0;color:var(--gray)}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  textarea, input[type="text"], input[type="number"]{width:100%;font-family:ui-monospace,Menlo,Consolas,monospace}
  .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
  .col-12{grid-column:span 12}
  .col-6{grid-column:span 6}
  .mini{color:var(--muted);font-size:12px}
  .btn{background:var(--orange);color:white;border:0;border-radius:10px;padding:8px 12px;cursor:pointer}
  .btn.secondary{background:#e5e7eb;color:#111827}
  table{border-collapse:collapse;width:100%;font-size:14px}
  th,td{border-bottom:1px solid #eee;padding:8px;text-align:left;vertical-align:top}
  .ok{color:var(--ok);font-weight:600}
  .err{color:var(--err)}
  .kbd{background:#f3f4f6;border:1px solid #e5e7eb;border-bottom-width:2px;padding:1px 4px;border-radius:4px;font-family:ui-monospace,Menlo,Consolas,monospace}
  select.facsel{min-width:260px;max-width:420px}
  #log{height:140px;overflow:auto;background:#0b1021;color:#b6c2ff;border-radius:10px;padding:8px;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;white-space:pre-wrap}
</style>
</head>
<body>
<div class="wrap">
  <header><h1>Bulk Rate Processor</h1><div class="mini">Units. miles . USD</div></header>

  <div class="card">
    <div class="row">
      <input id="csvFile" type="file" accept=".csv,text/csv"/>
      <button class="btn" id="processBtn">Process CSV</button>
      <button class="btn secondary" id="downloadBtn" disabled>Download Results CSV</button>
      <button class="btn secondary" id="templateBtn">Download Template CSV</button>
      <button class="btn" id="recalcBtn" disabled>Recalculate with selected facilities</button>
    </div>
    <div class="mini" style="margin-top:6px">Required column: <span class="kbd">input_address</span>.</div>
  </div>

  <details id="cfgPanel">
    <summary class="btn secondary" style="margin-bottom:8px">Show configuration . rate rules and facility list</summary>
    <div class="card">
      <div class="grid">
        <div class="col-6">
          <label class="mini">RPM Map (facility name -> $/mi). DEFAULT applies if no exact match</label>
          <textarea id="rpmJson" rows="16">{
  "DEFAULT": 3.00,
  "ATLANTA, GA - CSX & BNSF": 3.0,
  "ATLANTA, GA - NS AUSTELL": 3.0,
  "BALTIMORE, MD": 3.5,
  "BOSTON, MA": 3.5,
  "BUFFALO, NY": 5.0,
  "CHARLESTON, SC": 3.0,
  "CHARLOTTE, NC": 3.0,
  "CHICAGO, IL  - UP JOLIET INTERMODAL TERMINAL GLOBAL 4 (I206)": 3.0,
  "CHICAGO, IL -  NORFOLK SOUTHERN - LANDERS (I104)": 3.0,
  "CHICAGO, IL - BNSF - CHICAGO - LPC (H572)": 3.0,
  "CHICAGO, IL - CN RAIL - CHICAGO - HARVEY (I092)": 3.0,
  "CHICAGO, IL - CP RAIL - CHICAGO, BENSENVILLE (J830)": 3.0,
  "CHICAGO, IL - CSX (J470)": 3.0,
  "CINCINNATI, OH": 3.0,
  "CLEVELAND, OH": 3.0,
  "COLUMBUS, OH": 3.0,
  "DALLAS BNSF": 3.0,
  "DALLAS UPRR": 3.0,
  "DENVER - BNSF DENVER / UP DENVER": 5.0,
  "DENVER - BNSF HUDSON": 5.0,
  "DETROIT, MI": 3.0,
  "EL PASO/SANTA TERESA, NM": 5.0,
  "GREER, SC": 3.0,
  "HOUSTON, TX - HOUSTON PORT": 3.0,
  "INDIANAPOLIS, IN": 5.0,
  "JACKSONVILLE, FL": 3.0,
  "KANSAS CITY, KS - BNSF LOGISTICS PARK": 3.0,
  "KANSAS CITY, KS - CPKC - KANSAS CITY / CSX KANSAS CITY": 3.0,
  "KANSAS CITY, KS - NS VOLTZ / UP NEFF": 3.0,
  "LA/LB, CA PORTS": 3.25,
  "LOUISVILLE, KY": 3.0,
  "MEMPHIS, TN - BNSF - MEMPHIS (SHELBY)": 3.0,
  "MEMPHIS, TN - CN - INTERMODAL GATEWAY MEMPHIS": 3.0,
  "MEMPHIS, TN - CSX - MEMPHIS": 3.0,
  "MEMPHIS, TN - NS - ROSSVILLE,TN": 3.0,
  "MEMPHIS, TN - UP - MARION, AR": 3.0,
  "MIAMI, FL": 4.0,
  "MINNEAPOLIS, MN / ST. PAUL, MN": 3.0,
  "MOBILE, AL": 3.0,
  "NASHVILLE, TN": 3.0,
  "NEW ORLEANS, LA": 3.25,
  "NEW YORK, NY": 4.0,
  "NORFOLK, VA": 3.0,
  "OAKLAND, CA": 3.5,
  "OMAHA, NE / COUNCIL BLUFFS, IA": 3.0,
  "PHILADELPHIA, PA": 5.0,
  "PITTSBURGH, PA": 5.0,
  "PORT EVERGLADES, FL": 5.0,
  "PORTLAND OR": 3.5,
  "SALT LAKE CITY, UT": 3.0,
  "SAVANNAH, GA": 3.0,
  "SEATTLE WA": 3.25,
  "ST.LOUIS, MO": 3.0,
  "TACOMA WA": 3.0,
  "TAMPA, FL": 3.0,
  "WILMINGTON, NC": 3.0,
  "WORCESTER, MA": 5.0
}</textarea>
        </div>
        <div class="col-6">
          <label class="mini">Facilities (JSON or loose JS). name, type, lat, lon</label>
          <textarea id="facilitiesJson" rows="16">[
  {name:"ATLANTA, GA - CSX & BNSF", type:"IPI", lat:33.545109, lon:-84.609939},
  {name:"CHICAGO, IL - CN RAIL - CHICAGO - HARVEY (I092)", type:"IPI", lat:41.582582, lon:-87.646201},
  {name:"MEMPHIS, TN - CN - INTERMODAL GATEWAY MEMPHIS", type:"IPI", lat:35.031884, lon:-90.151894},
  {name:"MEMPHIS, TN - CSX - MEMPHIS", type:"IPI", lat:35.031884, lon:-90.151894},
  {name:"CHICAGO, IL - CP RAIL - CHICAGO, BENSENVILLE (J830)", type:"IPI", lat:41.941386, lon:-87.894674},
  {name:"CHICAGO, IL - BNSF - CHICAGO - LPC (H572)", type:"IPI", lat:41.393772, lon:-88.152065},
  {name:"CHICAGO, IL  - UP JOLIET INTERMODAL TERMINAL GLOBAL 4 (I206)", type:"IPI", lat:41.458470, lon:-88.118630},
  {name:"ATLANTA, GA - NS AUSTELL", type:"IPI", lat:33.822647, lon:-84.651274},
  {name:"CHICAGO, IL -  NORFOLK SOUTHERN - LANDERS (I104)", type:"IPI", lat:41.756107, lon:-87.683117},
  {name:"CHICAGO, IL - CSX (J470)", type:"IPI", lat:41.762825, lon:-87.799362},
  {name:"MEMPHIS, TN - UP - MARION, AR", type:"IPI", lat:35.191874, lon:-90.257432},
  {name:"HOUSTON, TX - HOUSTON PORT", type:"PORT", lat:29.673630, lon:-95.006670},
  {name:"DETROIT, MI", type:"IPI", lat:42.316722, lon:-83.133398},
  {name:"CINCINNATI, OH", type:"IPI", lat:39.121175, lon:-84.537791},
  {name:"KANSAS CITY, KS - CPKC - KANSAS CITY / CSX KANSAS CITY", type:"IPI", lat:38.859078, lon:-94.559678},
  {name:"MEMPHIS, TN - BNSF - MEMPHIS (SHELBY)", type:"IPI", lat:35.023622, lon:-89.900600},
  {name:"NEW YORK, NY", type:"PORT", lat:40.668837, lon:-74.156747},
  {name:"LA/LB, CA PORTS", type:"PORT", lat:33.782664, lon:-118.217784},
  {name:"KANSAS CITY, KS - NS VOLTZ / UP NEFF", type:"IPI", lat:39.181953, lon:-94.427906},
  {name:"MEMPHIS, TN - NS - ROSSVILLE,TN", type:"IPI", lat:35.005260, lon:-89.578705},
  {name:"KANSAS CITY, KS - BNSF LOGISTICS PARK", type:"IPI", lat:38.767739, lon:-94.984948},
  {name:"DALLAS UPRR", type:"IPI", lat:32.628501, lon:-96.680962},
  {name:"COLUMBUS, OH", type:"IPI", lat:39.995573, lon:-82.828357},
  {name:"LOUISVILLE, KY", type:"IPI", lat:38.114500, lon:-85.759700},
  {name:"OMAHA, NE / COUNCIL BLUFFS, IA", type:"IPI", lat:41.216343, lon:-95.929840},
  {name:"SAVANNAH, GA", type:"PORT", lat:32.127400, lon:-81.163200},
  {name:"CHARLOTTE, NC", type:"IPI", lat:35.272334, lon:-80.908698},
  {name:"DALLAS BNSF", type:"IPI", lat:32.964963, lon:-97.327672},
  {name:"ST.LOUIS, MO", type:"IPI", lat:38.601750, lon:-90.315587},
  {name:"NASHVILLE, TN", type:"IPI", lat:36.101542, lon:-86.756239},
  {name:"NEW ORLEANS, LA", type:"IPI", lat:29.915698, lon:-90.101184},
  {name:"WILMINGTON, NC", type:"PORT", lat:34.192767, lon:-77.945727},
  {name:"NORFOLK, VA", type:"PORT", lat:36.872573, lon:-76.358894},
  {name:"BALTIMORE, MD", type:"PORT", lat:39.258370, lon:-76.537550},
  {name:"OAKLAND, CA", type:"PORT", lat:37.796856, lon:-122.304260},
  {name:"CHARLESTON, SC", type:"PORT", lat:32.840553, lon:-79.953115},
  {name:"BOSTON, MA", type:"PORT", lat:42.339765, lon:-71.035435},
  {name:"SALT LAKE CITY, UT", type:"IPI", lat:40.771550, lon:-111.907986},
  {name:"CLEVELAND, OH", type:"IPI", lat:41.563840, lon:-81.575457},
  {name:"MOBILE, AL", type:"PORT", lat:30.666587, lon:-88.041873},
  {name:"GREER, SC", type:"IPI", lat:34.930864, lon:-82.192319},
  {name:"JACKSONVILLE, FL", type:"PORT", lat:30.394677, lon:-81.540770},
  {name:"MINNEAPOLIS, MN / ST. PAUL, MN", type:"IPI", lat:44.968859, lon:-93.172196},
  {name:"TAMPA, FL", type:"PORT", lat:27.919242, lon:-82.431773},
  {name:"MIAMI, FL", type:"PORT", lat:25.771817, lon:-80.165674},
  {name:"PORTLAND OR", type:"PORT", lat:45.638177, lon:-122.750626},
  {name:"PORT EVERGLADES, FL", type:"PORT", lat:26.081660, lon:-80.120584},
  {name:"SEATTLE WA", type:"PORT", lat:47.573856, lon:-122.348359},
  {name:"TACOMA WA", type:"PORT", lat:47.266552, lon:-122.410226},
  {name:"PITTSBURGH, PA", type:"IPI", lat:40.312725, lon:-79.900495},
  {name:"DENVER - BNSF DENVER / UP DENVER", type:"IPI", lat:39.790500, lon:-104.994500},
  {name:"DENVER - BNSF HUDSON", type:"IPI", lat:40.067600, lon:-104.628800},
  {name:"INDIANAPOLIS, IN", type:"IPI", lat:39.746623, lon:-86.164181},
  {name:"BUFFALO, NY", type:"IPI", lat:42.797787, lon:-78.834263},
  {name:"PHILADELPHIA, PA", type:"PORT", lat:39.900862, lon:-75.116517},
  {name:"WORCESTER, MA", type:"IPI", lat:42.224400, lon:-71.790708},
  {name:"EL PASO/SANTA TERESA, NM", type:"IPI", lat:31.752711, lon:-106.493000}
]</textarea>
        </div>
        <div class="col-6">
          <label class="mini">Base charge</label>
          <input id="baseCharge" type="number" value="250"/>
        </div>
        <div class="col-6">
          <label class="mini">Min charge</label>
          <input id="minCharge" type="number" value="350"/>
        </div>
        <div class="col-6">
          <label class="mini">Round-trip multiplier</label>
          <input id="rtx" type="number" value="2"/>
        </div>
        <div class="col-6">
          <label class="mini">Max allowed round-trip miles</label>
          <input id="maxMiles" type="number" value="800"/>
        </div>
        <div class="col-12">
          <label class="mini">OpenRouteService API key (optional . improves routing)</label>
          <input id="orsKey" type="text" placeholder=""/>
        </div>
      </div>
    </div>
  </details>

  <div class="card">
    <div class="mini" style="margin-bottom:8px">Processed rows. <span id="countOk">0 ok</span> . <span id="countErr" class="err">0 errors</span></div>
    <div style="overflow:auto">
      <table id="results">
        <thead><tr>
          <th>#</th><th>input_address</th><th>Facility Used</th><th>One-way mi</th><th>Round-trip mi</th><th>$/mi used</th><th>Computed Rate</th><th>Error Message</th>
        </tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="card">
    <div class="mini" style="margin-bottom:6px">Log</div>
    <div id="log"></div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const $ = (sel)=>document.querySelector(sel);
  const log = (m)=>{ const t=new Date().toISOString().replace('T',' ').replace('Z',''); const box=$('#log'); box.textContent += `[${t}] ${m}\n`; box.scrollTop=box.scrollHeight; };
  window.addEventListener('error', e=>log('JS error . ' + (e.message||e.error)));

  function tryParseJSON(txt, fallback){ try{ return JSON.parse(txt); }catch(e){ return fallback; } }
  function normalizeFacilities(text){
    let t = text.replace(/(^|\s)\/\/.*$/gm, '');
    t = t.replace(/,\s*([\]\}])/g, '$1');
    t = t.replace(/(\bname|\btype|\blat|\blon)\s*:/g, '"$1":');
    const trimmed = t.trim();
    try { return JSON.parse(trimmed); } catch(e){}
    const t2 = trimmed.replace(/'(.*?)'/g, '"$1"');
    try { return JSON.parse(t2); } catch(e){}
    return null;
  }
  function haversineMiles(lat1,lon1,lat2,lon2){
    const toRad = d => d * Math.PI / 180;
    const R = 3958.7613;
    const dLat = toRad(lat2-lat1), dLon = toRad(lon2-lon1);
    const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  }
  function dollars(x){ return isFinite(x) ? `$${Number(x).toFixed(2)}` : ''; }

  // Simple tolerant CSV: one column "input_address"
  function parseCsvSimple(text){
    if(text && text.charCodeAt(0)===0xFEFF) text = text.slice(1);
    text = String(text||'').replace(/\r\n/g,'\n').replace(/\r/g,'\n');
    const lines = text.split('\n').map(s=>s.trim()).filter(Boolean);
    if(lines.length===0) return {header:[], data:[]};
    const header = lines[0].replace(/,+$/,'').split(',').map(h=>h.trim());
    const idx = header.findIndex(h=>/^input_address$/i.test(h));
    if(idx===-1) return {header, data:[]};
    const rows = [];
    for(let i=1;i<lines.length;i++){
      let ln = lines[i].replace(/,+$/,'');
      let addr = '';
      if(/^"/.test(ln)){ const m = ln.match(/^"([^"]*)"/); addr = m?m[1]:ln.replace(/^"+|"+$/g,''); }
      else { addr = ln.split(',')[0]; }
      addr = addr.trim();
      if(addr) rows.push({input_address: addr});
    }
    return {header:['input_address'], data: rows};
  }

  async function routeMilesOSRM(o,d){
    const url=`https://router.project-osrm.org/route/v1/driving/${o.lon},${o.lat};${d.lon},${d.lat}?overview=false`;
    const resp=await fetch(url);
    if(!resp.ok) throw new Error('OSRM HTTP ' + resp.status);
    const j=await resp.json();
    const meters=j && j.routes && j.routes[0] && j.routes[0].distance;
    if(!isFinite(meters)) throw new Error('OSRM bad response');
    return meters*0.000621371;
  }
  async function routeMiles(o,d,key){
    if(key){
      try{
        const resp = await fetch('https://api.openrouteservice.org/v2/directions/driving-car', {
          method:'POST', headers:{'Content-Type':'application/json','Authorization':key},
          body: JSON.stringify({coordinates:[[o.lon,o.lat],[d.lon,d.lat]]})
        });
        if(resp.ok){
          const jj = await resp.json();
          const m = jj && jj.features && jj.features[0] && jj.features[0].properties && jj.features[0].properties.segments && jj.features[0].properties.segments[0] && jj.features[0].properties.segments[0].distance;
          if(isFinite(m)) return m*0.000621371;
        }
      }catch(e){ log('ORS failed . ' + e.message); }
    }
    return await routeMilesOSRM(o,d);
  }

  function computeRate(rtMiles, facilityName, cfg){
    const rpmMap = cfg.rpmMap||{};
    const rpm = Number((facilityName in rpmMap) ? rpmMap[facilityName] : (rpmMap.DEFAULT ?? 3.00));
    const raw = Number(cfg.baseCharge) + rpm * rtMiles;
    return { rpm, applied: Math.max(Number(cfg.minCharge), raw) };
  }

  function facilityOptionsHTML(currentName){
    const list = (window.__facilitiesList||[]).slice().sort((a,b)=>String(a.name).localeCompare(String(b.name)));
    const esc = (s)=> String(s??'').replace(/[&<>\"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    return list.map(f=>{
      const sel = (String(f.name)===String(currentName)) ? ' selected' : '';
      return `<option value="${esc(f.name)}"${sel}>${esc(f.name)}</option>`;
    }).join('');
  }

  const state = { results: [] };

  function appendRow(r){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td class="mini">${r.row}</td>
      <td>${r.input_address}</td>
      <td><select class="facsel" data-row="${r.row}">${facilityOptionsHTML(r.facility_used || '')}</select></td>
      <td>${r.one_way_mi}</td>
      <td>${r.round_trip_mi}</td>
      <td>${r.rpm_used}</td>
      <td><span class="${r.computed_rate ? 'ok':''}">${r.computed_rate}</span></td>
      <td><span class="err">${r.error_message || ''}</span></td>`;
    document.querySelector('#results tbody').appendChild(tr);
  }

  function downloadCSV(rows, filename){
    const esc = (v)=> `"${String(v??'').replace(/"/g,'""')}"`;
    const header = ['row','input_address','facility_used','one_way_mi','round_trip_mi','rpm_used','computed_rate','error_message'];
    const lines = [header.join(',')];
    for(const r of rows){ lines.push([r.row, r.input_address, r.facility_used, r.one_way_mi, r.round_trip_mi, r.rpm_used, r.computed_rate, r.error_message].map(esc).join(',')); }
    const blob = new Blob([lines.join('\r\n')], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = filename; a.click();
    setTimeout(()=>URL.revokeObjectURL(url), 1000);
  }

  function downloadTemplate(){
    const header = 'input_address\r\n';
    const samples = ['Ontario, CA','Pacifica, CA','Tacoma, WA'].join('\r\n');
    const blob = new Blob([header + samples + '\r\n'], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'bulk_template.csv'; a.click();
    setTimeout(()=>URL.revokeObjectURL(url), 1000);
  }

  async function geocodeUS(q){
    const url = `https://nominatim.openstreetmap.org/search?format=json&countrycodes=us&q=${encodeURIComponent(q)}&limit=3&addressdetails=0`;
    const resp = await fetch(url, {headers:{'Accept':'application/json'}});
    if(!resp.ok) throw new Error('Geocode HTTP ' + resp.status);
    const arr = await resp.json(); if(!arr||!arr.length) throw new Error('No match found');
    return {lat:parseFloat(arr[0].lat), lon:parseFloat(arr[0].lon)};
  }

  // Wire buttons
  $('#templateBtn').addEventListener('click', downloadTemplate);
  $('#downloadBtn').addEventListener('click', ()=>{ if(state.results.length===0){ alert('No results to download'); return; } downloadCSV(state.results, 'bulk_rate_results.csv'); });

  $('#processBtn').addEventListener('click', async ()=>{
    const btn = $('#processBtn'); btn.disabled = true; btn.textContent = 'Processing...';
    try{
      const file = $('#csvFile').files && $('#csvFile').files[0];
      if(!file){ alert('Choose a CSV file first'); log('No file selected'); return; }
      log('File selected: ' + (file.name||'(no name)'));

      let facilities = tryParseJSON($('#facilitiesJson').value, null);
      if(!facilities){ facilities = normalizeFacilities($('#facilitiesJson').value); }
      if(!Array.isArray(facilities) || facilities.length===0){ alert('Facilities list is invalid.'); log('Facilities parse failed'); return; }
      facilities = facilities.map(f=>({name:String(f.name), type:String(f.type||''), lat:Number(f.lat), lon:Number(f.lon)})).filter(f=>isFinite(f.lat) && isFinite(f.lon));
      window.__facilitiesList = facilities;

      const rpmMap = tryParseJSON($('#rpmJson').value, {DEFAULT:3.0});
      const cfg = { baseCharge:Number($('#baseCharge').value||250), minCharge:Number($('#minCharge').value||350), rtx:Number($('#rtx').value||2), maxMiles:Number($('#maxMiles').value||800), rpmMap };
      const orsKey = ($('#orsKey').value||'').trim();

      $('#downloadBtn').disabled = true;
      $('#recalcBtn').disabled = true;
      state.results = [];
      $('#results tbody').innerHTML='';
      $('#countOk').textContent='0 ok'; $('#countErr').textContent='0 errors';

      const text = await file.text();
      log('Bytes read: ' + text.length);
      const parsed = parseCsvSimple(text);
      log('Header: ' + JSON.stringify(parsed.header) + ' . Rows: ' + parsed.data.length);
      if(!parsed.data.length){ alert('CSV has no data rows'); return; }

      let ok=0, err=0, rn=0;
      for(const row of parsed.data){
        rn++;
        const out = {row: rn, input_address: row.input_address, facility_used:'', one_way_mi:'', round_trip_mi:'', rpm_used:'', computed_rate:'', error_message:''};
        try{
          const geo = await geocodeUS(out.input_address);
          // pick nearest by routed miles among the 6 nearest haversine
          const pre = facilities.map(f=>({f, d:haversineMiles(geo.lat,geo.lon,f.lat,f.lon)})).sort((a,b)=>a.d-b.d).slice(0, Math.min(6, facilities.length));
          let best = null;
          for(const cand of pre){
            try{
              const miles = await routeMiles(geo, {lat:cand.f.lat, lon:cand.f.lon}, orsKey);
              if(!best || miles < best.miles) best = {f:cand.f, miles};
            }catch(e){ log('Routing fail for ' + cand.f.name + ' . ' + e.message); }
          }
          if(!best) best = { f: pre[0].f, miles: pre[0].d, fallback: true };
          const oneWay = best.miles;
          const rt = oneWay * cfg.rtx;
          out.facility_used = best.f.name + (best.fallback ? ' (approx)' : '');
          out.one_way_mi = oneWay.toFixed(1);
          out.round_trip_mi = rt.toFixed(1);
          if(rt > cfg.maxMiles) throw new Error('Distance is too large, please choose an alternate routing or reach out to US.KApex.FCL.Trucking@KLN.COM');
          const rcalc = computeRate(rt, best.f.name, cfg);
          out.rpm_used = rcalc.rpm.toFixed(2);
          out.computed_rate = dollars(rcalc.applied);
          ok++;
        }catch(e){
          out.error_message = String(e.message||e);
          out.rpm_used = '';
          out.computed_rate = '';
          err++;
        }
        state.results.push(out); appendRow(out);
        $('#countOk').textContent = ok + ' ok'; $('#countErr').textContent = err + ' errors';
      }
      $('#downloadBtn').disabled = state.results.length === 0;
      $('#recalcBtn').disabled = state.results.length === 0;
    } finally {
      const btn2 = $('#processBtn'); btn2.disabled = false; btn2.textContent = 'Process CSV';
    }
  });

  $('#recalcBtn').addEventListener('click', async ()=>{
    const orsKey = ($('#orsKey').value||'').trim();
    const cfg = { baseCharge:Number($('#baseCharge').value||250), minCharge:Number($('#minCharge').value||350), rtx:Number($('#rtx').value||2), maxMiles:Number($('#maxMiles').value||800), rpmMap: tryParseJSON($('#rpmJson').value, {DEFAULT:3.0}) };
    let ok=0, err=0;
    for(const r of state.results){
      const sel = document.querySelector(`select.facsel[data-row="${r.row}"]`);
      if(!sel) continue;
      const targetName = sel.value;
      try{
        const geo = await geocodeUS((r.input_address||'').trim());
        const target = (window.__facilitiesList||[]).find(f=>String(f.name)===String(targetName));
        if(!target) throw new Error('Facility not found');
        let oneWay, routedFallback=false;
        try{ oneWay = await routeMiles(geo, {lat:target.lat, lon:target.lon}, orsKey); }
        catch(e){ oneWay = haversineMiles(geo.lat, geo.lon, target.lat, target.lon); routedFallback=true; }
        const rt = oneWay * cfg.rtx;
        r.facility_used = target.name + (routedFallback ? ' (approx)' : '');
        r.one_way_mi = oneWay.toFixed(1);
        r.round_trip_mi = rt.toFixed(1);
        if(rt > cfg.maxMiles) throw new Error('Distance is too large, please choose an alternate routing or reach out to US.KApex.FCL.Trucking@KLN.COM');
        const rcalc = computeRate(rt, target.name, cfg);
        r.rpm_used = rcalc.rpm.toFixed(2);
        r.computed_rate = dollars(rcalc.applied);
        r.error_message = '';
        ok++;
      }catch(e){
        r.error_message = String(e.message||e);
        r.rpm_used = '';
        r.computed_rate = '';
        err++;
      }
    }
    document.querySelector('#results tbody').innerHTML='';
    for(const r of state.results) appendRow(r);
    document.getElementById('countOk').textContent = ok + ' ok';
    document.getElementById('countErr').textContent = err + ' errors';
  });
});
</script>
</body>
</html>
